Lab 6. Continuous Deployment with Flux CD

Prerequisites

Create a Personal Access Token with full repository access. To do so, login to your GitHub
account and go to Settings.

From account Settings, select Developer Settings.

Choose Personal Access Token and click on Generate.

Provide a name for the token, select full repo access, along with admin:repo_hook →
read:repo_hook and click on Create.

Retain the page which displays the token (one time) until you set the environment variables in
your shell permanently.

Set up the environment variables, preferably permanently, in the shell profile script by adding
the following lines in ~/.bashrc or the equivalent file for your shell.
Make sure you have replaced the values of the token and user with the actual values, by
removing < >.

export GITHUB_TOKEN=<your-personal-access-token>
export GITHUB_USER=<your-github-username>

Install Flux CLI

To set up continuous deployment with Flux, begin by downloading and installing the Flux CLI.

On Mac:

brew install fluxcd/tap/flux

On Mac or Linux using curl:

curl -s https://fluxcd.io/install.sh | sudo bash
[Sample Output]
```
[INFO] Downloading metadata
https://api.github.com/repos/fluxcd/flux2/releases/latest
[INFO] Using 2.0.0-rc.3 as release
[INFO] Downloading hash
https://github.com/fluxcd/flux2/releases/download/v2.0.0-rc.3/flux_2.0
.0-rc.3_checksums.txt
[INFO] Downloading binary
https://github.com/fluxcd/flux2/releases/download/v2.0.0-rc.3/flux_2.0
.0-rc.3_linux_amd64


For additional Operating Systems Support, please refer to the Flux Installation documentation.

To enable bash completion, add the following to ~/.bashrc
echo "source /etc/bash_completion" >> ~/.bashrc
echo ". <(flux completion bash)" >> ~/.bashrc
Also install bash-completion as needed.
e.g.
apt update
apt install bash-completion
Apply the configs to the current shell:
source ~/.bashrc_________________________

To validate, run flux followed by double Tab (press the Tab key twice), and you should see an
output similar to the following:
# flux [tab][tab]
bootstrap
completion
suspend
check
create
uninstall

Bootstrap a Flux Environment

Bootstrapping Flux means you would:

Install the components of the Flux/GitOps Toolkit, including various controllers, CRDs,
RBAC and Network Policies
Set up a repository which would be used by Flux CD. Either create a new one, or use an
existing repo provided
Set up a Deploy Key (read-only) to connect to the repository created above so that
FluxCD can sync with it
Begin with a pre-flight check:

kubectl get nodes
kubectl config get-contexts
kubectl get pods --all-namespaces

kubectl get crds
flux check --pre

If the checks pass, go ahead and set up Flux using the following bootstrap sequence:

flux bootstrap github
--owner=$GITHUB_USER \
--repository=flux-infra \
--branch=main \
--path=./clusters/dev \
--personal \
--log-level=debug \
--network-policy=false \
--components=source-controller,kustomize-controller

Source: [flux-bootstrap ·
GitHub](https://gist.github.com/initcron/4d97c508ce617200263274cc48526c79)
Validate:
flux check
[sample output]
► checking prerequisites
✔ kubectl 1.20.4 >=1.18.0-0
✔ Kubernetes 1.20.4 >=1.16.0-0
► checking controllers
✔ kustomize-controller: deployment ready
► ghcr.io/fluxcd/kustomize-controller:v0.9.3
✔ source-controller: deployment ready
► ghcr.io/fluxcd/source-controller:v0.9.1
✔ all checks passed
Expected: You should see source-controller and kustomize-controller created as
above.
To find out everything that Flux creates on the Kubernetes side, use the following commands:

kubectl get crds
kubectl get pods -n flux-system
kubectl get all -n flux-system
kubectl get clusterroles,clusterrolebindings,serviceaccounts -n
flux-system -l "app.kubernetes.io/instance=flux-system"
Also check the following on GitHub:

A repository on GitHub with the user provided in the bootstrap command (e.g.
https://github.com/xxxxxx/flux-infra)
A deploy key configured for the repository above

Kubernetes manifests to sync with the cluster inside the flux-system subdirectory.

kustomization.yaml in the same path as above, which is read by Flux CD to
determine which manifests to apply.
To check the kustomisations and sources created by Flux, run:

flux get kustomizations
flux get sources git


Set Up the Application Deployment

Deploying an application to a Kubernetes cluster with Flux is a two-step process:

Sync the Git repository
Create Kustomization to apply manifests

Create a Git Source to Sync with the Repository

To sync the Git repo, you need to create a source of type git repository. The CRD used for this
would be GitRepository. To generate a manifest with such a source, use the following
command:

flux create source git instavote \
--url=https://github.com/xxx/instavote.git \
--branch=main \
--interval=30s

You could check the YAML generated by showing the content of it, validate by listing the source
as:

flux get sources git


Create Kustomization to Apply Manifests

Before creating the kustomization, check whether the kustomization and the source for it exists
already:

flux get kustomization
flux get sources git
The kustomization does not exist, but the source does. Also, make sure you have the
namespace created:
kubectl get ns
kubectl delete ns instavote
kubectl create ns instavote
kubectl get ns


To create the kustomization:

flux create kustomization vote-dev \
--source=instavote \
--path="./deploy/vote" \
--prune=true \
--interval=1m \
--target-namespace=instavote

Note: validation option is now deprecated, and all resources are
applied server side validation by default.
flux get sources
flux get kustomizations
flux reconcile kustomization vote-dev
flux reconcile source git instavote
Validate by running:
flux get kustomizations
kubectl get all -n instavote
kubectl get all -n instavote --show-labels

Validate the Continuous Deploy

Note: Earlier, as part of the best practices, you might have set up branch protection rules which
disallow commits to the main branch. While that is useful in real environments with many
developers contributing to the repository, it could be counter-productive while you have a lab
environment and trying to learn by quickly making changes. We would recommend removing the
branch policy while you are working on these labs, and then re-apply them when you start
implementing it in an actual environment .
Now, to test whether Flux is continuously applying changes to the cluster or not, try to update
the code and observe what happens.
One simple change would be to edit the deployment.yaml file, which is at the
instavote/deploy/vote path in the repo.

And update the number of replicas to 4

Commit the change.

Note: You may have to disable the branch protection rules at this time in order to allow changes
to go to the main branch.
And observe whether it has changed the replica count or not. You could do so by watching for
the changes in the instavote namespace:
watch kubectl get all -n instavote
In case the reconciliation does not happen, you could trigger it manually:
flux reconcile source git instavote
flux reconcile kustomization vote-dev


Generate and Commit Flux Manifests

Manifests to run the kustomization and source sync can be added to the
flux-infra/clusters/dev path of the flux-infra repo.
Begin first by cloning the flux-infra repo that was created as part of the Flux bootstrap
process. You must clone your own repository; the following image is just for representation.

git clone https://github.com/xxxxxx/flux-infra.git
Where you should replace xxxxxx with the actual user/org name.
Since it's a private repository, you have to provide the credentials while cloning it.
Once it clones, switch to the relevant path:

cd
flux-infra/clusters/dev
To export Flux objects, you could use the export command:
flux export [tab][tab]
e.g.
flux export source git instavote
flux export kustomization vote-dev

You could export the source and the kustomization as YAML and redirect the output to files:

flux export source git instavote >> instavote-gitrepository.yaml
flux export kustomization vote-dev >> vote-dev-kustomization.yaml

Add and push the code to the Git repository:

git status
git add *
git commit -am "adding source and kustomizations to deploy vote app"
git push origin main